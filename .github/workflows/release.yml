name: Build and Release APK

on:
  push:
    branches:
      - main
    paths:
      - 'pubspec.yaml'  # ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ pubspec.yaml ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ workflow

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      app-version: ${{ steps.extract-version.outputs.version }}
      build-number: ${{ steps.extract-version.outputs.build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event_name == 'workflow_dispatch' && '1' || '2' }}  # Ø¨Ø±Ø§ÛŒ workflow_dispatch ÙÙ‚Ø· 1 commit Ù„Ø§Ø²Ù… Ø§Ø³Øª
      
      - name: Check if version changed
        id: check
        run: |
          # If workflow is triggered manually (workflow_dispatch), always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          # Check if there's a previous commit
          elif git rev-parse --verify HEAD~1 > /dev/null 2>&1; then
            # Compare with previous commit
            if git diff HEAD~1 HEAD -- pubspec.yaml | grep -q "^[+-].*version:"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          else
            # First commit, consider it as version change
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract version from pubspec.yaml
        id: extract-version
        run: |
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD=$(grep "^version:" pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "Version: $VERSION+$BUILD"

  build:
    needs: check-version-change
    if: needs.check-version-change.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout after 30 minutes
    permissions:
      contents: write  # Required to create releases
      packages: write  # Required if publishing packages
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install dependencies
        run: |
          echo "Installing Flutter dependencies..."
          flutter pub get
          echo "âœ“ Dependencies installed"
      
      - name: Build separate APKs for each architecture
        continue-on-error: true
        run: |
          echo "=== Building separate APKs for each architecture ==="
          
          # Build arm64-v8a
          echo ""
          echo "--- Building arm64-v8a ---"
          if flutter build apk --release --target-platform android-arm64; then
            # Rename the APK to include architecture name
            if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
              mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
              echo "âœ“ arm64-v8a build successful and renamed"
            fi
          else
            echo "âœ— arm64-v8a build failed"
          fi
          
          # Build armeabi-v7a
          echo ""
          echo "--- Building armeabi-v7a ---"
          if flutter build apk --release --target-platform android-arm; then
            # Rename the APK to include architecture name
            if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
              mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
              echo "âœ“ armeabi-v7a build successful and renamed"
            fi
          else
            echo "âœ— armeabi-v7a build failed"
          fi
          
          # Build x86_64 (skip x86 as it's not commonly used)
          echo ""
          echo "--- Building x86_64 ---"
          if flutter build apk --release --target-platform android-x64; then
            # Rename the APK to include architecture name
            if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
              mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/app-x86_64-release.apk
              echo "âœ“ x86_64 build successful and renamed"
            fi
          else
            echo "âœ— x86_64 build failed"
          fi
          
          echo ""
          echo "=== Checking all built APKs ==="
          echo "All APK files in build/app/outputs/flutter-apk/:"
          find build/app/outputs/flutter-apk -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found"
          
          echo ""
          echo "=== APK file names ==="
          ls -1 build/app/outputs/flutter-apk/*.apk 2>/dev/null || echo "No APK files found"
      
      - name: Build Universal APK
        run: |
          echo "=== Building Universal APK ==="
          echo "Building universal APK (includes all architectures)..."
          
          # Build universal APK
          flutter build apk --release
          
          # Verify APK was created
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            echo "âœ“ Universal APK built successfully"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âœ— ERROR: Universal APK not found!"
            exit 1
          fi
      
      - name: Prepare APK for release
        run: |
          echo "=== Preparing APK for release ==="
          VERSION="${{ needs.check-version-change.outputs.app-version }}"
          BUILD="${{ needs.check-version-change.outputs.build-number }}"
          TAG="v${VERSION}"
          
          echo "Version: $VERSION"
          echo "Build: $BUILD"
          echo "Tag: $TAG (version only, without build number)"
          
          mkdir -p release-apks
          
          # Copy universal APK
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-release.apk release-apks/Irage_${TAG}_universal.apk
            echo "âœ“ Universal APK copied: Irage_${TAG}_universal.apk"
            ls -lh release-apks/Irage_${TAG}_universal.apk
          else
            echo "âœ— ERROR: Universal APK not found!"
            exit 1
          fi
          
          # Copy separate APKs if they exist
          echo ""
          echo "=== Copying separate APKs ==="
          
          # Check and copy arm64-v8a
          if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" "release-apks/Irage_${TAG}_arm64-v8a.apk"
            echo "âœ“ arm64-v8a APK copied"
          else
            echo "âš  arm64-v8a APK not found"
          fi
          
          # Check and copy armeabi-v7a
          if [ -f "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" "release-apks/Irage_${TAG}_armeabi-v7a.apk"
            echo "âœ“ armeabi-v7a APK copied"
          else
            echo "âš  armeabi-v7a APK not found"
          fi
          
          # Check and copy x86_64 (x86 skipped as it's not commonly used)
          if [ -f "build/app/outputs/flutter-apk/app-x86_64-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-x86_64-release.apk" "release-apks/Irage_${TAG}_x86_64.apk"
            echo "âœ“ x86_64 APK copied"
          else
            echo "âš  x86_64 APK not found"
          fi
          
          echo ""
          echo "=== Final APK files ==="
          ls -lh release-apks/
          
          # Verify at least one APK exists
          APK_COUNT=$(ls -1 release-apks/*.apk 2>/dev/null | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "âœ— ERROR: No APK files found in release-apks directory!"
            exit 1
          fi
          echo "âœ“ Found $APK_COUNT APK file(s) ready for release"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version-change.outputs.app-version }}
          name: Release v${{ needs.check-version-change.outputs.app-version }}
          body: |
            ## Irage Calendar v${{ needs.check-version-change.outputs.app-version }}
            
            A professional Iranian Heritage Calendar app with cross-platform support.
            
            ### ðŸ“¥ Download APK
            
            Choose the APK file that matches your device's architecture:
            
            - **arm64-v8a**: For modern 64-bit Android devices (recommended for most users)
            - **armeabi-v7a**: For older 32-bit Android devices
            - **x86_64**: For x86_64 emulators and tablets
            - **universal**: Includes all architectures (larger file size, compatible with all devices)
            
            > ðŸ’¡ **Tip**: If you're unsure about your device's architecture, download the **universal** APK - it works on all devices.
            
            ### ðŸ“± Installation Instructions
            
            1. Download the appropriate APK file for your device architecture
            2. Open the downloaded file and follow the installation prompts
            3. If prompted, enable "Install from unknown sources" in your device settings
            
            ### âœ¨ Features
            
            - Beautiful and modern UI with Persian language support
            - Complete Iranian calendar (Shahanshahi/Jalali/Shamsi) integration
            - Customizable calendar settings
            - Offline functionality
            - Lightweight and optimized performance
            
            ### ðŸ”„ What's New
            
            - Initial release with core calendar functionality
            - Support for multiple device architectures
            - Persian and English language support
            - Modern Material Design UI
            
            ---
            
            **Note**: This is the initial release. More features and improvements are coming soon!
          files: |
            release-apks/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

