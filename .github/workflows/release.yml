name: Build and Release APK

on:
  push:
    branches:
      - main
    paths:
      - 'pubspec.yaml'  # ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ pubspec.yaml ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ workflow

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      app-version: ${{ steps.extract-version.outputs.version }}
      build-number: ${{ steps.extract-version.outputs.build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event_name == 'workflow_dispatch' && '1' || '2' }}  # Ø¨Ø±Ø§ÛŒ workflow_dispatch ÙÙ‚Ø· 1 commit Ù„Ø§Ø²Ù… Ø§Ø³Øª
      
      - name: Check if version changed
        id: check
        run: |
          # If workflow is triggered manually (workflow_dispatch), always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          # Check if there's a previous commit
          elif git rev-parse --verify HEAD~1 > /dev/null 2>&1; then
            # Compare with previous commit
            if git diff HEAD~1 HEAD -- pubspec.yaml | grep -q "^[+-].*version:"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          else
            # First commit, consider it as version change
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract version from pubspec.yaml
        id: extract-version
        run: |
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD=$(grep "^version:" pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "Version: $VERSION+$BUILD"

  build:
    needs: check-version-change
    if: needs.check-version-change.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout after 30 minutes
    permissions:
      contents: write  # Required to create releases
      packages: write  # Required if publishing packages
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install dependencies
        run: |
          echo "Installing Flutter dependencies..."
          flutter pub get
          echo "âœ“ Dependencies installed"
      
      - name: Build Universal APK
        run: |
          echo "=== Building Universal APK ==="
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Flutter doctor:"
          flutter doctor
          echo ""
          echo "Starting build..."
          
          # Build and capture output
          set +e  # Don't exit on error immediately
          flutter build apk --release 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âœ—âœ—âœ— BUILD FAILED (Exit code: $BUILD_EXIT_CODE) âœ—âœ—âœ—"
            echo ""
            echo "=== Last 150 lines of build log ==="
            tail -150 build.log
            echo ""
            echo "=== Searching for ERROR keywords ==="
            grep -i "error" build.log | tail -20 || echo "No 'error' found in log"
            echo ""
            echo "=== Searching for FAILED keywords ==="
            grep -i "failed" build.log | tail -20 || echo "No 'failed' found in log"
            echo ""
            echo "=== Full build log saved above ==="
            exit $BUILD_EXIT_CODE
          fi
          
          echo "âœ“ Build command completed"
          
          # Verify APK was created
          echo ""
          echo "=== Verifying APK file ==="
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            echo "âœ“ APK file found: build/app/outputs/flutter-apk/app-release.apk"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
            file build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âœ— ERROR: APK file not found!"
            echo "Searching for any APK files:"
            find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
            echo ""
            echo "Contents of build/app/outputs/:"
            find build/app/outputs -type f 2>/dev/null | head -20
            echo ""
            echo "Build log (last 200 lines):"
            tail -200 build.log || echo "No build log found"
            exit 1
          fi
      
      - name: Build separate APKs for each architecture
        run: |
          echo "=== Building separate APKs for each architecture ==="
          
          # Build arm64-v8a
          echo "Building arm64-v8a..."
          flutter build apk --release --target-platform android-arm64 || echo "âš  arm64-v8a build failed"
          
          # Build armeabi-v7a
          echo "Building armeabi-v7a..."
          flutter build apk --release --target-platform android-arm || echo "âš  armeabi-v7a build failed"
          
          # Build x86
          echo "Building x86..."
          flutter build apk --release --target-platform android-x86 || echo "âš  x86 build failed"
          
          # Build x86_64
          echo "Building x86_64..."
          flutter build apk --release --target-platform android-x64 || echo "âš  x86_64 build failed"
          
          echo ""
          echo "=== Checking built APKs ==="
          find build/app/outputs/flutter-apk -name "*.apk" -type f -exec ls -lh {} \;
      
      - name: Prepare APK for release
        run: |
          echo "=== Preparing APK for release ==="
          VERSION="${{ needs.check-version-change.outputs.app-version }}"
          BUILD="${{ needs.check-version-change.outputs.build-number }}"
          TAG="v${VERSION}+${BUILD}"
          
          echo "Version: $VERSION"
          echo "Build: $BUILD"
          echo "Tag: $TAG"
          
          mkdir -p release-apks
          
          # Copy universal APK
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-release.apk release-apks/Irage_${TAG}_universal.apk
            echo "âœ“ Universal APK copied: Irage_${TAG}_universal.apk"
            ls -lh release-apks/Irage_${TAG}_universal.apk
          else
            echo "âœ— ERROR: Universal APK not found!"
            exit 1
          fi
          
          # Try to copy separate APKs if they exist (optional)
          for arch in arm64-v8a armeabi-v7a x86 x86_64; do
            if [ -f "build/app/outputs/flutter-apk/app-${arch}-release.apk" ]; then
              cp "build/app/outputs/flutter-apk/app-${arch}-release.apk" "release-apks/Irage_${TAG}_${arch}.apk"
              echo "âœ“ ${arch} APK copied"
            fi
          done
          
          echo ""
          echo "=== Final APK files ==="
          ls -lh release-apks/
          
          # Verify at least one APK exists
          APK_COUNT=$(ls -1 release-apks/*.apk 2>/dev/null | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "âœ— ERROR: No APK files found in release-apks directory!"
            exit 1
          fi
          echo "âœ“ Found $APK_COUNT APK file(s) ready for release"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version-change.outputs.app-version }}+${{ needs.check-version-change.outputs.build-number }}
          name: Release v${{ needs.check-version-change.outputs.app-version }}+${{ needs.check-version-change.outputs.build-number }}
          body: |
            ## Irage Calendar v${{ needs.check-version-change.outputs.app-version }}+${{ needs.check-version-change.outputs.build-number }}
            
            A professional Iranian Heritage Calendar app with cross-platform support.
            
            ### ðŸ“¥ Download APK
            
            Choose the APK file that matches your device's architecture:
            
            - **arm64-v8a**: For modern 64-bit Android devices (recommended for most users)
            - **armeabi-v7a**: For older 32-bit Android devices
            - **x86**: For x86 emulators and tablets
            - **x86_64**: For x86_64 emulators and tablets
            - **universal**: Includes all architectures (larger file size, compatible with all devices)
            
            > ðŸ’¡ **Tip**: If you're unsure about your device's architecture, download the **universal** APK - it works on all devices.
            
            ### ðŸ“± Installation Instructions
            
            1. Download the appropriate APK file for your device architecture
            2. Open the downloaded file and follow the installation prompts
            3. If prompted, enable "Install from unknown sources" in your device settings
            
            ### âœ¨ Features
            
            - Beautiful and modern UI with Persian language support
            - Complete Iranian calendar (Jalali/Shamsi) integration
            - Event management and reminders
            - Customizable themes and settings
            - Offline functionality
            - Lightweight and optimized performance
            
            ### ðŸ”„ What's New
            
            - Initial release with core calendar functionality
            - Support for multiple device architectures
            - Persian and English language support
            - Modern Material Design UI
            
            ---
            
            **Note**: This is the initial release. More features and improvements are coming soon!
          files: |
            release-apks/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

